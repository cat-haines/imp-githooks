# imp-githooks

The imp-githooks project is an incredibly simple webserver designed to be used with [GitHub's Webhooks](https://developer.github.com/webhooks/) to deploy code to your Electric Imp devices whenever you push changes to the master branch of a tracked repository.

## Limitations

This project is primairly aimed as a proof of concept, and intended to act as a starting point for more complex Electric Imp + GitHub CI tools.

### Requirements

This guide will help you setup and configure a simple webserver on a free Heroku instance to process GitHub Webhooks. You will need the following:

- [Node.js and npm](https://docs.npmjs.com/getting-started/installing-node)
- [A Heroku account](https://signup.heroku.com/login)
- [The Heroku Toolbelt](https://toolbelt.heroku.com/)
- [An Electric Imp account](https://ide.electricimp.com)
- [An Electric Imp Build API Key*](https://electricimp.com/docs/buildapi/keys/)
- [The imp-cli](https://github.com/matt-haines/imp-cli#installation)
- [A GitHub account](https://github.com/join)
- [A GitHub token*](https://help.github.com/articles/creating-an-access-token-for-command-line-use/)

\***NOTE:** We recommend you create seperate API Keys and tokens for use with imp-githooks.

### Step 1: Clone the imp-githooks repository

```bash
$ git clone git@github.com:matt-haines/imp-githooks.git
$ cd imp-webhooks
```

### Step 2: Create and configure the Heroku app

```bash
$ heroku create
$ git push heroku master
$ heroku ps:scale web=1
$ heroku config:set BUILD_API_KEY=BuildApiKey
$ heroku config:set GIT_PUSH_SECRET=YourSecret
$ heroku config:set GIT_USER=YourGitHubUserName
$ heroku config:set GIT_TOKEN=YourGitHubToken
```

We'll use the GIT_PUSH_SECRET when setting up our GitHub webhook. It should be something unique and difficult to guess.

When you run the `heroku create` command, it should return with the URL of your app (in the example below it is https://damp-inlet-8875.herokuapp.com/):

```bash
$ heroku create
Creating damp-inlet-8875... done, stack is cedar-14
https://damp-inlet-8875.herokuapp.com/ | https://git.heroku.com/damp-inlet-8875.git
Git remote heroku added
```

### Step 3: Setup a Webhook in GitHub

- Browse your GitHub repository and click on "Settings" -> "Webhooks and services"
- Click "Add Webhook"
- Set the "Payload URL" to your apps URL with "/webhook" appended to the end of it
  - i.e. https://damp-inlet-8875.herokuapp.com/webhook
- Set the "Secret" to the GIT_PUSH_SECRET you set in your Heroku app.
- Click "Add Webhook"

## Creating imp-githook Compatible Repositories

The imp-githook server is intended to be used with the config files generated by the imp-cli. To create a new project run the the `imp init` command with the `-g` option (which prevents your Build API Key from being injected into the .impconfig file).

```bash
$ imp init -g
```

Whenever a commit is made to the master branch of a repository with the proper webhooks and .impconfig setup, the imp-githook server will push the new code to each device associated with the model, and restart the devices.

For a sample project, view [imp-test](https://github.com/matt-haines/imp-test).

# License

The imp-githooks project is licensed under the [MIT License](./LICENSE).
